# 剑与魔法的世界 - AI驱动的RPG游戏

这是一个基于大型语言模型（LLM）的网页RPG游戏，由AI扮演游戏管理员，创造动态且沉浸式的奇幻冒险体验。

## 功能特点

- 🎮 **AI驱动的游戏管理员**：使用Gemini LLM创造丰富的剧情和互动
- 🖼️ **动态图像生成**：为每个场景自动生成视觉图像
- 💾 **本地数据存储**：使用IndexedDB在浏览器中保存游戏进度
- 🎨 **沉浸式界面**：深色奇幻主题的用户界面
- 🌟 **完全客户端**：无需服务器，所有处理都在浏览器中完成

## 快速开始

### 1. 获取API密钥

在开始游戏之前，您需要获取Gemini API密钥：

1. 访问 [Google AI Studio](https://makersuite.google.com/app/apikey)
2. 创建一个新的API密钥
3. 复制该密钥备用

### 2. 启动游戏

1. 在浏览器中打开 `index.html` 文件
2. 点击右上角的"设置"按钮
3. 输入您的Gemini API密钥并保存
4. 开始创建您的角色！

### 3. 创建角色

1. 输入角色姓名（必填）
2. 描述您的角色（可选）：
   - 性别、年龄、外貌
   - 性格特点
   - 职业背景
   - 其他特殊设定
3. 点击"创建角色"，AI会为您完善角色的详细属性

### 4. 开始冒险

- 在输入框中输入您的行动
- 点击建议的行动按钮快速执行
- 使用快捷命令查看状态：
  - **查看状态**：显示角色的详细信息
  - **查看角色**：显示所有角色信息
  - **查看环境**：显示当前环境详情

## 游戏特色

### 世界设定

游戏设定在一个奇幻的剑与魔法世界中，包含：

- **中央大陆**（亚欧大陆）
- **新北大陆**（北美大陆）
- **新南大陆**（南美大陆）
- **旧大陆**（非洲大陆）
- **离岛**（澳洲大陆）
- **冰封大陆**（南极大陆）

主要国家包括达利帝国、梅斯共和国、布列塔尼亚王国等。

### 游戏机制

- **HP系统**：需要治疗才能恢复生命值
- **MP系统**：通过休息恢复魔法值
- **技能系统**：使用技能消耗MP
- **经验系统**：通过冒险获得经验值升级

### 角色系统

每个角色都有完整的属性系统：

- **基础属性**：姓名、性别、年龄、外貌、性格等
- **数值属性**：HP、MP、攻击力、防御力等
- **技能系统**：魔法、战技、特技等
- **状态效果**：增益和减益效果

## 技术架构

- **前端**：HTML5、CSS3、JavaScript (ES6+)
- **数据库**：IndexedDB（浏览器本地存储）
- **AI服务**：Gemini LLM（文本生成和图像生成）
- **架构**：单页应用程序（SPA）

## 文件结构

```
ai-role-play-game/
├── index.html          # 主页面
├── style.css           # 样式文件
├── app.js              # 主应用逻辑
├── db.js               # 数据库管理
├── llm.js              # LLM服务
├── image.js            # 图像生成服务
├── prompt.md           # 游戏提示词
├── generate_text.py    # Python示例（文本生成）
├── generate_image.py   # Python示例（图像生成）
├── requirements.txt    # Python依赖
└── README.md           # 说明文档
```

## 游戏命令

### 基本命令

- 直接输入行动描述，如"向前走"、"攻击敌人"
- 使用建议动作按钮快速执行

### 快捷命令

- **查看状态**：显示角色状态
- **查看角色**：显示所有角色信息
- **查看环境**：显示环境详情

### 特殊命令

在输入框中输入以下命令（以/开头）：

- `/status` - 查看详细状态
- `/chars` - 查看所有角色
- `/env` - 查看环境信息

## 调试指南

### 开启调试模式

1. **打开开发者工具**：
   - Chrome/Edge: 按F12或右键 → 检查
   - Firefox: 按F12或右键 → 检查元素
   - Safari: 开发 → 显示网页检查器

2. **查看控制台日志**：
   - 切换到Console选项卡
   - 游戏会输出详细的API调用信息
   - 关注错误消息和API响应

### 测试步骤

1. **API连接测试**：
   - 在设置面板中输入API密钥
   - 点击"测试API连接"按钮
   - 查看测试结果和控制台日志

2. **角色创建测试**：
   - 使用简单的角色名称（如"小明"）
   - 角色描述保持简短（少于100字）
   - 检查控制台中的API响应

3. **游戏动作测试**：
   - 输入简单的动作（如"向前走"）
   - 观察响应格式和内容
   - 检查是否有JSON解析错误

### 常见调试信息

- `发送API请求:` - 显示请求参数
- `API响应状态:` - 显示HTTP状态码
- `原始响应文本:` - 显示完整的API响应
- `成功解析JSON:` - 显示解析后的结构化数据

## 故障排除

### 常见问题

1. **角色创建失败 - API密钥问题**
   - **获取API密钥**：访问 [Google AI Studio](https://aistudio.google.com/app/apikey)
   - **创建新密钥**：点击"Create API Key"
   - **复制密钥**：完整复制生成的API密钥
   - **检查密钥格式**：API密钥通常以 `AIza` 开头
   - **确认权限**：确保API密钥有Gemini API的使用权限
   - **检查配额**：确认API配额是否足够

2. **"Cannot read properties of undefined"错误**
   - 这通常是API响应格式问题或token限制
   - **调试步骤**：
     1. 打开浏览器开发者工具（F12）
     2. 查看Console选项卡中的详细错误信息
     3. 点击"测试API连接"按钮验证API密钥
     4. 如果测试成功但创建角色失败，可能是响应太长被截断
   - **解决方案**：
     - 确认API密钥有效且未过期
     - 尝试重新生成API密钥
     - 简化角色描述，避免过长的输入

3. **图像生成问题**
   - 使用Gemini 2.0 Flash Preview图像生成模型
   - 如果图像生成失败，会显示占位图像
   - 图像生成可能需要较长时间，请耐心等待
   - 文本游戏体验不受图像生成影响

4. **游戏数据丢失**
   - 游戏数据存储在浏览器本地
   - 清除浏览器数据会导致游戏进度丢失
   - 建议定期备份重要角色信息

### 性能优化

- 图像生成具有缓存机制
- 定期清理游戏日志以节省存储空间
- 关闭不必要的浏览器标签页以提高性能

## 开发说明

### 本地开发

1. 克隆仓库
2. 使用本地Web服务器运行（推荐）
3. 或直接在浏览器中打开index.html

### 扩展功能

游戏采用模块化设计，可以轻松扩展：

- 添加新的游戏机制
- 集成其他AI服务
- 自定义UI主题
- 添加音效和音乐

### API使用说明

游戏使用Gemini API的两个主要功能：

1. **文本生成**：使用 `gemini-2.5-flash` 模型，用于游戏剧情和对话
2. **图像生成**：使用 `gemini-2.0-flash-preview-image-generation` 模型，用于场景图像

请确保您的API密钥有相应的权限和配额。

## 许可证

本项目采用MIT许可证。详见LICENSE文件。

## 贡献

欢迎提交问题和Pull Request来改进这个游戏！

## 联系方式

如果您有任何问题或建议，请提交Issue或联系项目维护者。

---

**开始您的奇幻冒险之旅吧！** 🗡️✨

## 场景缓存功能

### 查看环境命令优化

"查看环境"快捷命令现在支持智能缓存机制：

1. **首次查看环境**：当你推进到一个新场景后，第一次点击"查看环境"，系统会：
   - 调用大模型生成基于当前场景、对话历史和角色状态的详细环境描述
   - 自动生成匹配的场景图像
   - 将环境描述和图像缓存到本地数据库

2. **再次查看环境**：在同一场景中再次点击"查看环境"，系统会：
   - 直接从缓存中读取之前生成的环境信息
   - 立即显示，无需等待大模型处理
   - 节省API调用次数和等待时间

3. **场景变化检测**：系统会自动检测场景变化：
   - 当玩家的行动导致场景变化时（如移动到新地点、进入不同区域等）
   - 自动清除旧的场景缓存
   - 为新场景分配新的场景ID
   - 下次查看环境时重新生成新的环境描述

### 场景变化关键词

系统会监测以下关键词来判断场景是否发生变化：
- 位置移动：来到、到达、进入、离开、走向、前往、返回
- 传送动作：传送、移动、穿过、越过、跨过、走出、走进
- 环境名词：场景、地点、位置、环境、区域、房间、街道
- 具体场所：森林、城市、村庄、山脉、海边、洞穴、建筑

### 技术实现

- **场景ID管理**：每个场景都有唯一的ID，存储在数据库中
- **缓存存储**：使用IndexedDB的scenesCache存储区保存场景信息
- **自动清理**：场景变化时自动清除过时的缓存
- **数据持久化**：缓存数据在浏览器会话间保持

这个优化大大提升了游戏体验，减少了重复的API调用，同时保持了环境信息的准确性。

## 响应式设计优化

### 移动端体验优化

游戏现在完全支持移动设备，提供了优化的触摸体验：

#### 界面适配
- **桌面端（>768px）**：完整的两栏布局，最大化利用屏幕空间
- **平板端（≤768px）**：垂直布局，控制面板置顶，模态框适配屏幕宽度
- **手机端（≤480px）**：专门优化的单列布局，触摸友好的按钮设计

#### 模态框优化
- 桌面端：最大宽度1000px，90%屏幕宽度
- 平板端：95%屏幕宽度，适中的内边距
- 手机端：98%屏幕宽度，紧凑的布局

#### 触摸友好设计
- 按钮最小高度44px，符合移动端触摸标准
- 关闭按钮圆形设计，增加触摸面积
- 列表项增加最小高度，避免误触
- 去除触摸高亮效果，提升用户体验

#### 内容优化
- 角色详情页面字体大小和间距优化
- 装备和物品列表垂直排列，便于阅读
- 图片自适应尺寸，保持比例
- 自定义滚动条，提升视觉体验

### 响应式特性
- 网格布局自适应屏幕宽度
- 弹性布局适配不同设备
- 图片响应式缩放
- 文字大小分级优化
- 触摸交互优化

移动端用户可以享受与桌面端相同的完整功能，同时获得专门优化的触摸体验。

## 数值系统优化

### 智能数值变化处理

为了确保大模型返回的数值变化准确对应角色的实际属性，我们对数值系统进行了全面优化：

#### 问题解决
- **问题**：大模型可能返回角色不存在的属性（如"奥秘学识熟练度"、"精力"等）
- **解决方案**：在prompt中明确告知大模型所有可修改的字段及其当前值和范围

#### 改进功能

##### 1. 明确的字段约束
系统现在会在prompt中明确列出所有可修改的数值字段：
- **基础属性**：hp、mp、stamina、money、experience
- **战斗属性**：attack、defense、magicAttack、magicDefense、dexterity、luck
- **生活状态**：hunger、thirst、fatigue、morale

##### 2. 智能格式解析
支持多种数值变化格式：
- 简单数字：`{"hp": -10}`
- 带符号：`{"hp": "+5"}`
- 带说明：`{"hp": "-5 (受伤流血)"}`

##### 3. 严格验证机制
- 只处理角色实际存在的数值字段
- 忽略不存在的字段并给出警告
- 确保数值在合理范围内（如HP不超过最大值）

##### 4. 详细的变化显示
系统会清晰显示所有数值变化：
```
📊 数值变化:
生命值: 100 → 90 (-10) (战斗受伤)
魔法值: 50 → 45 (-5)
经验值: 120 → 170 (+50)
```

##### 5. 错误处理和反馈
- 被忽略的字段会在游戏日志中显示警告
- 格式错误的数值会被标记并跳过
- 提供详细的控制台日志便于调试

#### 技术特性
- **边界检查**：自动确保数值不超出合理范围
- **类型安全**：严格验证数值类型
- **向后兼容**：支持原有的简单数字格式
- **用户友好**：中文字段名显示，易于理解

这个优化确保了大模型生成的数值变化既准确又安全，同时为玩家提供了清晰的反馈信息。

